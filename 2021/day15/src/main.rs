use std::cmp::Reverse;
use std::collections::BinaryHeap;
use std::collections::HashSet;

const EXTEND: usize = 5;

#[derive(Debug, PartialEq)]
struct Grid {
    columns: usize,
    points: Vec<u32>,
}

impl Grid {
    fn from_str(input: &str) -> Grid {
        let mut lines = input.lines();
        let mut points = Vec::<u32>::new();
        let mut columns = 0;
        while let Some(line) = lines.next() {
            let row: Vec<u32> = line
                .chars()
                .map(|n| n.to_string().parse::<u32>().expect("Expected a number"))
                .collect();
            if columns != 0 && row.len() != columns {
                panic!("Grid must have columns of equal size");
            }
            columns = row.len();
            points.extend(row);
        }
        Grid {
            columns: columns,
            points: points,
        }
    }

    fn extend(&self) -> Grid {
        let orig_columns = self.columns;
        let orig_rows = self.points.len() / self.columns;
        let columns = self.columns * EXTEND;
        let new_len = self.points.len() * EXTEND * EXTEND;
        let rows = new_len / columns;
        let mut points = Vec::with_capacity(new_len);
        for r in 0..rows {
            let tile_y = (r / orig_rows) as u32;
            let orig_row = (r % orig_rows) * orig_columns;
            for c in 0..columns {
                let tile_x = (c / orig_columns) as u32;
                let orig_i = (c % orig_columns) + orig_row;
                let v = self.points[orig_i] + tile_x + tile_y;
                points.push(if v > 9 { v - 9 } else { v });
            }
        }
        Grid {
            columns: columns,
            points: points,
        }
    }

    fn adjacents(&self, i: usize) -> Vec<usize> {
        let c = self.columns;
        let p = &self.points;
        let mut adj: Vec<usize> = vec![];
        if i >= c {
            // not at the first column, use above neighbor
            adj.push(i - c);
        }
        if i > 0 && i % c != 0 {
            // not at the left border, use left neighbor
            adj.push(i - 1);
        }
        if (i + 1) % c != 0 {
            // not at the right border, use right neighbor
            adj.push(i + 1);
        }
        if i < p.len() - c {
            // not at the last column, use below neighbor
            adj.push(i + c);
        }
        adj
    }

    // find shortest path between two points
    fn shortest_path_weight(&self, from: usize, to: usize) -> u32 {
        // calculate minimum distances with Djikstra's Shortest Path algorithm
        // https://brilliant.org/wiki/dijkstras-short-path-finder/
        let mut dist = vec![u32::MAX; self.points.len()];
        dist[from] = 0;
        let mut visited: HashSet<usize> = HashSet::new();
        let mut to_visit = BinaryHeap::from_iter(
            self.adjacents(from)
                .iter()
                .map(|v| Reverse((self.points[*v], *v))),
        );
        to_visit.push(Reverse((0, from)));
        while !to_visit.is_empty() {
            let Reverse((_, v)) = to_visit.pop().unwrap();
            if !visited.insert(v) {
                // already visited this point
                continue;
            }
            let adjs = self.adjacents(v);
            for adj in adjs {
                let alt = dist[v] + self.points[adj];
                to_visit.push(Reverse((alt, adj)));
                if alt < dist[adj] {
                    dist[adj] = alt
                }
            }
        }
        dist[to]
    }
}

fn main() {
    let input = std::fs::read_to_string("input.txt").unwrap();
    let grid = Grid::from_str(&input);
    println!(
        "Total risk of shortest path in original grid: {}",
        grid.shortest_path_weight(0, grid.points.len() - 1)
    );
    let extended_grid = grid.extend();
    println!(
        "Total risk of shortest path in extended grid: {}",
        extended_grid.shortest_path_weight(0, extended_grid.points.len() - 1)
    );
}

#[cfg(test)]
mod tests {
    use super::*;

    const HEIGHTMAP: &str = "1163751742
1381373672
2136511328
3694931569
7463417111
1319128137
1359912421
3125421639
1293138521
2311944581";

    #[test]
    fn test_parse_grid() {
        assert_eq!(
            Grid::from_str(HEIGHTMAP),
            Grid {
                columns: 10,
                points: vec![
                    1, 1, 6, 3, 7, 5, 1, 7, 4, 2, 1, 3, 8, 1, 3, 7, 3, 6, 7, 2, 2, 1, 3, 6, 5, 1,
                    1, 3, 2, 8, 3, 6, 9, 4, 9, 3, 1, 5, 6, 9, 7, 4, 6, 3, 4, 1, 7, 1, 1, 1, 1, 3,
                    1, 9, 1, 2, 8, 1, 3, 7, 1, 3, 5, 9, 9, 1, 2, 4, 2, 1, 3, 1, 2, 5, 4, 2, 1, 6,
                    3, 9, 1, 2, 9, 3, 1, 3, 8, 5, 2, 1, 2, 3, 1, 1, 9, 4, 4, 5, 8, 1,
                ]
            }
        )
    }

    #[test]
    fn test_adj() {
        let grid = Grid::from_str(HEIGHTMAP);
        assert_eq!(grid.adjacents(0), vec![1, 10]);
        assert_eq!(grid.adjacents(5), vec![4, 6, 15]);
        assert_eq!(grid.adjacents(9), vec![8, 19]);
        assert_eq!(grid.adjacents(10), vec![0, 11, 20]);
        assert_eq!(grid.adjacents(15), vec![5, 14, 16, 25]);
        assert_eq!(grid.adjacents(20), vec![10, 21, 30]);
        assert_eq!(grid.adjacents(25), vec![15, 24, 26, 35]);
        assert_eq!(grid.adjacents(90), vec![80, 91]);
        assert_eq!(grid.adjacents(99), vec![89, 98]);
    }

    #[test]
    fn test_shortest_path() {
        let grid = Grid::from_str(HEIGHTMAP);
        assert_eq!(grid.shortest_path_weight(0, 99), 40);
        let extended_grid = grid.extend();
        assert_eq!(
            extended_grid.shortest_path_weight(0, extended_grid.points.len() - 1),
            315
        );
    }

    #[test]
    fn test_extend_grid() {
        let grid = Grid::from_str(HEIGHTMAP);
        assert_eq!(
            grid.extend(),
            Grid {
                columns: 50,
                points: vec![
                    1, 1, 6, 3, 7, 5, 1, 7, 4, 2, 2, 2, 7, 4, 8, 6, 2, 8, 5, 3, 3, 3, 8, 5, 9, 7,
                    3, 9, 6, 4, 4, 4, 9, 6, 1, 8, 4, 1, 7, 5, 5, 5, 1, 7, 2, 9, 5, 2, 8, 6, 1, 3,
                    8, 1, 3, 7, 3, 6, 7, 2, 2, 4, 9, 2, 4, 8, 4, 7, 8, 3, 3, 5, 1, 3, 5, 9, 5, 8,
                    9, 4, 4, 6, 2, 4, 6, 1, 6, 9, 1, 5, 5, 7, 3, 5, 7, 2, 7, 1, 2, 6, 2, 1, 3, 6,
                    5, 1, 1, 3, 2, 8, 3, 2, 4, 7, 6, 2, 2, 4, 3, 9, 4, 3, 5, 8, 7, 3, 3, 5, 4, 1,
                    5, 4, 6, 9, 8, 4, 4, 6, 5, 2, 6, 5, 7, 1, 9, 5, 5, 7, 6, 3, 3, 6, 9, 4, 9, 3,
                    1, 5, 6, 9, 4, 7, 1, 5, 1, 4, 2, 6, 7, 1, 5, 8, 2, 6, 2, 5, 3, 7, 8, 2, 6, 9,
                    3, 7, 3, 6, 4, 8, 9, 3, 7, 1, 4, 8, 4, 7, 5, 9, 1, 4, 7, 4, 6, 3, 4, 1, 7, 1,
                    1, 1, 8, 5, 7, 4, 5, 2, 8, 2, 2, 2, 9, 6, 8, 5, 6, 3, 9, 3, 3, 3, 1, 7, 9, 6,
                    7, 4, 1, 4, 4, 4, 2, 8, 1, 7, 8, 5, 2, 5, 5, 5, 1, 3, 1, 9, 1, 2, 8, 1, 3, 7,
                    2, 4, 2, 1, 2, 3, 9, 2, 4, 8, 3, 5, 3, 2, 3, 4, 1, 3, 5, 9, 4, 6, 4, 3, 4, 5,
                    2, 4, 6, 1, 5, 7, 5, 4, 5, 6, 3, 5, 7, 2, 1, 3, 5, 9, 9, 1, 2, 4, 2, 1, 2, 4,
                    6, 1, 1, 2, 3, 5, 3, 2, 3, 5, 7, 2, 2, 3, 4, 6, 4, 3, 4, 6, 8, 3, 3, 4, 5, 7,
                    5, 4, 5, 7, 9, 4, 4, 5, 6, 8, 6, 5, 3, 1, 2, 5, 4, 2, 1, 6, 3, 9, 4, 2, 3, 6,
                    5, 3, 2, 7, 4, 1, 5, 3, 4, 7, 6, 4, 3, 8, 5, 2, 6, 4, 5, 8, 7, 5, 4, 9, 6, 3,
                    7, 5, 6, 9, 8, 6, 5, 1, 7, 4, 1, 2, 9, 3, 1, 3, 8, 5, 2, 1, 2, 3, 1, 4, 2, 4,
                    9, 6, 3, 2, 3, 4, 2, 5, 3, 5, 1, 7, 4, 3, 4, 5, 3, 6, 4, 6, 2, 8, 5, 4, 5, 6,
                    4, 7, 5, 7, 3, 9, 6, 5, 2, 3, 1, 1, 9, 4, 4, 5, 8, 1, 3, 4, 2, 2, 1, 5, 5, 6,
                    9, 2, 4, 5, 3, 3, 2, 6, 6, 7, 1, 3, 5, 6, 4, 4, 3, 7, 7, 8, 2, 4, 6, 7, 5, 5,
                    4, 8, 8, 9, 3, 5, 2, 2, 7, 4, 8, 6, 2, 8, 5, 3, 3, 3, 8, 5, 9, 7, 3, 9, 6, 4,
                    4, 4, 9, 6, 1, 8, 4, 1, 7, 5, 5, 5, 1, 7, 2, 9, 5, 2, 8, 6, 6, 6, 2, 8, 3, 1,
                    6, 3, 9, 7, 2, 4, 9, 2, 4, 8, 4, 7, 8, 3, 3, 5, 1, 3, 5, 9, 5, 8, 9, 4, 4, 6,
                    2, 4, 6, 1, 6, 9, 1, 5, 5, 7, 3, 5, 7, 2, 7, 1, 2, 6, 6, 8, 4, 6, 8, 3, 8, 2,
                    3, 7, 3, 2, 4, 7, 6, 2, 2, 4, 3, 9, 4, 3, 5, 8, 7, 3, 3, 5, 4, 1, 5, 4, 6, 9,
                    8, 4, 4, 6, 5, 2, 6, 5, 7, 1, 9, 5, 5, 7, 6, 3, 7, 6, 8, 2, 1, 6, 6, 8, 7, 4,
                    4, 7, 1, 5, 1, 4, 2, 6, 7, 1, 5, 8, 2, 6, 2, 5, 3, 7, 8, 2, 6, 9, 3, 7, 3, 6,
                    4, 8, 9, 3, 7, 1, 4, 8, 4, 7, 5, 9, 1, 4, 8, 2, 5, 9, 5, 8, 6, 1, 2, 5, 8, 5,
                    7, 4, 5, 2, 8, 2, 2, 2, 9, 6, 8, 5, 6, 3, 9, 3, 3, 3, 1, 7, 9, 6, 7, 4, 1, 4,
                    4, 4, 2, 8, 1, 7, 8, 5, 2, 5, 5, 5, 3, 9, 2, 8, 9, 6, 3, 6, 6, 6, 2, 4, 2, 1,
                    2, 3, 9, 2, 4, 8, 3, 5, 3, 2, 3, 4, 1, 3, 5, 9, 4, 6, 4, 3, 4, 5, 2, 4, 6, 1,
                    5, 7, 5, 4, 5, 6, 3, 5, 7, 2, 6, 8, 6, 5, 6, 7, 4, 6, 8, 3, 2, 4, 6, 1, 1, 2,
                    3, 5, 3, 2, 3, 5, 7, 2, 2, 3, 4, 6, 4, 3, 4, 6, 8, 3, 3, 4, 5, 7, 5, 4, 5, 7,
                    9, 4, 4, 5, 6, 8, 6, 5, 6, 8, 1, 5, 5, 6, 7, 9, 7, 6, 4, 2, 3, 6, 5, 3, 2, 7,
                    4, 1, 5, 3, 4, 7, 6, 4, 3, 8, 5, 2, 6, 4, 5, 8, 7, 5, 4, 9, 6, 3, 7, 5, 6, 9,
                    8, 6, 5, 1, 7, 4, 8, 6, 7, 1, 9, 7, 6, 2, 8, 5, 2, 3, 1, 4, 2, 4, 9, 6, 3, 2,
                    3, 4, 2, 5, 3, 5, 1, 7, 4, 3, 4, 5, 3, 6, 4, 6, 2, 8, 5, 4, 5, 6, 4, 7, 5, 7,
                    3, 9, 6, 5, 6, 7, 5, 8, 6, 8, 4, 1, 7, 6, 3, 4, 2, 2, 1, 5, 5, 6, 9, 2, 4, 5,
                    3, 3, 2, 6, 6, 7, 1, 3, 5, 6, 4, 4, 3, 7, 7, 8, 2, 4, 6, 7, 5, 5, 4, 8, 8, 9,
                    3, 5, 7, 8, 6, 6, 5, 9, 9, 1, 4, 6, 3, 3, 8, 5, 9, 7, 3, 9, 6, 4, 4, 4, 9, 6,
                    1, 8, 4, 1, 7, 5, 5, 5, 1, 7, 2, 9, 5, 2, 8, 6, 6, 6, 2, 8, 3, 1, 6, 3, 9, 7,
                    7, 7, 3, 9, 4, 2, 7, 4, 1, 8, 3, 5, 1, 3, 5, 9, 5, 8, 9, 4, 4, 6, 2, 4, 6, 1,
                    6, 9, 1, 5, 5, 7, 3, 5, 7, 2, 7, 1, 2, 6, 6, 8, 4, 6, 8, 3, 8, 2, 3, 7, 7, 9,
                    5, 7, 9, 4, 9, 3, 4, 8, 4, 3, 5, 8, 7, 3, 3, 5, 4, 1, 5, 4, 6, 9, 8, 4, 4, 6,
                    5, 2, 6, 5, 7, 1, 9, 5, 5, 7, 6, 3, 7, 6, 8, 2, 1, 6, 6, 8, 7, 4, 8, 7, 9, 3,
                    2, 7, 7, 9, 8, 5, 5, 8, 2, 6, 2, 5, 3, 7, 8, 2, 6, 9, 3, 7, 3, 6, 4, 8, 9, 3,
                    7, 1, 4, 8, 4, 7, 5, 9, 1, 4, 8, 2, 5, 9, 5, 8, 6, 1, 2, 5, 9, 3, 6, 1, 6, 9,
                    7, 2, 3, 6, 9, 6, 8, 5, 6, 3, 9, 3, 3, 3, 1, 7, 9, 6, 7, 4, 1, 4, 4, 4, 2, 8,
                    1, 7, 8, 5, 2, 5, 5, 5, 3, 9, 2, 8, 9, 6, 3, 6, 6, 6, 4, 1, 3, 9, 1, 7, 4, 7,
                    7, 7, 3, 5, 3, 2, 3, 4, 1, 3, 5, 9, 4, 6, 4, 3, 4, 5, 2, 4, 6, 1, 5, 7, 5, 4,
                    5, 6, 3, 5, 7, 2, 6, 8, 6, 5, 6, 7, 4, 6, 8, 3, 7, 9, 7, 6, 7, 8, 5, 7, 9, 4,
                    3, 5, 7, 2, 2, 3, 4, 6, 4, 3, 4, 6, 8, 3, 3, 4, 5, 7, 5, 4, 5, 7, 9, 4, 4, 5,
                    6, 8, 6, 5, 6, 8, 1, 5, 5, 6, 7, 9, 7, 6, 7, 9, 2, 6, 6, 7, 8, 1, 8, 7, 5, 3,
                    4, 7, 6, 4, 3, 8, 5, 2, 6, 4, 5, 8, 7, 5, 4, 9, 6, 3, 7, 5, 6, 9, 8, 6, 5, 1,
                    7, 4, 8, 6, 7, 1, 9, 7, 6, 2, 8, 5, 9, 7, 8, 2, 1, 8, 7, 3, 9, 6, 3, 4, 2, 5,
                    3, 5, 1, 7, 4, 3, 4, 5, 3, 6, 4, 6, 2, 8, 5, 4, 5, 6, 4, 7, 5, 7, 3, 9, 6, 5,
                    6, 7, 5, 8, 6, 8, 4, 1, 7, 6, 7, 8, 6, 9, 7, 9, 5, 2, 8, 7, 4, 5, 3, 3, 2, 6,
                    6, 7, 1, 3, 5, 6, 4, 4, 3, 7, 7, 8, 2, 4, 6, 7, 5, 5, 4, 8, 8, 9, 3, 5, 7, 8,
                    6, 6, 5, 9, 9, 1, 4, 6, 8, 9, 7, 7, 6, 1, 1, 2, 5, 7, 4, 4, 9, 6, 1, 8, 4, 1,
                    7, 5, 5, 5, 1, 7, 2, 9, 5, 2, 8, 6, 6, 6, 2, 8, 3, 1, 6, 3, 9, 7, 7, 7, 3, 9,
                    4, 2, 7, 4, 1, 8, 8, 8, 4, 1, 5, 3, 8, 5, 2, 9, 4, 6, 2, 4, 6, 1, 6, 9, 1, 5,
                    5, 7, 3, 5, 7, 2, 7, 1, 2, 6, 6, 8, 4, 6, 8, 3, 8, 2, 3, 7, 7, 9, 5, 7, 9, 4,
                    9, 3, 4, 8, 8, 1, 6, 8, 1, 5, 1, 4, 5, 9, 5, 4, 6, 9, 8, 4, 4, 6, 5, 2, 6, 5,
                    7, 1, 9, 5, 5, 7, 6, 3, 7, 6, 8, 2, 1, 6, 6, 8, 7, 4, 8, 7, 9, 3, 2, 7, 7, 9,
                    8, 5, 9, 8, 1, 4, 3, 8, 8, 1, 9, 6, 6, 9, 3, 7, 3, 6, 4, 8, 9, 3, 7, 1, 4, 8,
                    4, 7, 5, 9, 1, 4, 8, 2, 5, 9, 5, 8, 6, 1, 2, 5, 9, 3, 6, 1, 6, 9, 7, 2, 3, 6,
                    1, 4, 7, 2, 7, 1, 8, 3, 4, 7, 1, 7, 9, 6, 7, 4, 1, 4, 4, 4, 2, 8, 1, 7, 8, 5,
                    2, 5, 5, 5, 3, 9, 2, 8, 9, 6, 3, 6, 6, 6, 4, 1, 3, 9, 1, 7, 4, 7, 7, 7, 5, 2,
                    4, 1, 2, 8, 5, 8, 8, 8, 4, 6, 4, 3, 4, 5, 2, 4, 6, 1, 5, 7, 5, 4, 5, 6, 3, 5,
                    7, 2, 6, 8, 6, 5, 6, 7, 4, 6, 8, 3, 7, 9, 7, 6, 7, 8, 5, 7, 9, 4, 8, 1, 8, 7,
                    8, 9, 6, 8, 1, 5, 4, 6, 8, 3, 3, 4, 5, 7, 5, 4, 5, 7, 9, 4, 4, 5, 6, 8, 6, 5,
                    6, 8, 1, 5, 5, 6, 7, 9, 7, 6, 7, 9, 2, 6, 6, 7, 8, 1, 8, 7, 8, 1, 3, 7, 7, 8,
                    9, 2, 9, 8, 6, 4, 5, 8, 7, 5, 4, 9, 6, 3, 7, 5, 6, 9, 8, 6, 5, 1, 7, 4, 8, 6,
                    7, 1, 9, 7, 6, 2, 8, 5, 9, 7, 8, 2, 1, 8, 7, 3, 9, 6, 1, 8, 9, 3, 2, 9, 8, 4,
                    1, 7, 4, 5, 3, 6, 4, 6, 2, 8, 5, 4, 5, 6, 4, 7, 5, 7, 3, 9, 6, 5, 6, 7, 5, 8,
                    6, 8, 4, 1, 7, 6, 7, 8, 6, 9, 7, 9, 5, 2, 8, 7, 8, 9, 7, 1, 8, 1, 6, 3, 9, 8,
                    5, 6, 4, 4, 3, 7, 7, 8, 2, 4, 6, 7, 5, 5, 4, 8, 8, 9, 3, 5, 7, 8, 6, 6, 5, 9,
                    9, 1, 4, 6, 8, 9, 7, 7, 6, 1, 1, 2, 5, 7, 9, 1, 8, 8, 7, 2, 2, 3, 6, 8, 5, 5,
                    1, 7, 2, 9, 5, 2, 8, 6, 6, 6, 2, 8, 3, 1, 6, 3, 9, 7, 7, 7, 3, 9, 4, 2, 7, 4,
                    1, 8, 8, 8, 4, 1, 5, 3, 8, 5, 2, 9, 9, 9, 5, 2, 6, 4, 9, 6, 3, 1, 5, 7, 3, 5,
                    7, 2, 7, 1, 2, 6, 6, 8, 4, 6, 8, 3, 8, 2, 3, 7, 7, 9, 5, 7, 9, 4, 9, 3, 4, 8,
                    8, 1, 6, 8, 1, 5, 1, 4, 5, 9, 9, 2, 7, 9, 2, 6, 2, 5, 6, 1, 6, 5, 7, 1, 9, 5,
                    5, 7, 6, 3, 7, 6, 8, 2, 1, 6, 6, 8, 7, 4, 8, 7, 9, 3, 2, 7, 7, 9, 8, 5, 9, 8,
                    1, 4, 3, 8, 8, 1, 9, 6, 1, 9, 2, 5, 4, 9, 9, 2, 1, 7, 7, 1, 4, 8, 4, 7, 5, 9,
                    1, 4, 8, 2, 5, 9, 5, 8, 6, 1, 2, 5, 9, 3, 6, 1, 6, 9, 7, 2, 3, 6, 1, 4, 7, 2,
                    7, 1, 8, 3, 4, 7, 2, 5, 8, 3, 8, 2, 9, 4, 5, 8, 2, 8, 1, 7, 8, 5, 2, 5, 5, 5,
                    3, 9, 2, 8, 9, 6, 3, 6, 6, 6, 4, 1, 3, 9, 1, 7, 4, 7, 7, 7, 5, 2, 4, 1, 2, 8,
                    5, 8, 8, 8, 6, 3, 5, 2, 3, 9, 6, 9, 9, 9, 5, 7, 5, 4, 5, 6, 3, 5, 7, 2, 6, 8,
                    6, 5, 6, 7, 4, 6, 8, 3, 7, 9, 7, 6, 7, 8, 5, 7, 9, 4, 8, 1, 8, 7, 8, 9, 6, 8,
                    1, 5, 9, 2, 9, 8, 9, 1, 7, 9, 2, 6, 5, 7, 9, 4, 4, 5, 6, 8, 6, 5, 6, 8, 1, 5,
                    5, 6, 7, 9, 7, 6, 7, 9, 2, 6, 6, 7, 8, 1, 8, 7, 8, 1, 3, 7, 7, 8, 9, 2, 9, 8,
                    9, 2, 4, 8, 8, 9, 1, 3, 1, 9, 7, 5, 6, 9, 8, 6, 5, 1, 7, 4, 8, 6, 7, 1, 9, 7,
                    6, 2, 8, 5, 9, 7, 8, 2, 1, 8, 7, 3, 9, 6, 1, 8, 9, 3, 2, 9, 8, 4, 1, 7, 2, 9,
                    1, 4, 3, 1, 9, 5, 2, 8, 5, 6, 4, 7, 5, 7, 3, 9, 6, 5, 6, 7, 5, 8, 6, 8, 4, 1,
                    7, 6, 7, 8, 6, 9, 7, 9, 5, 2, 8, 7, 8, 9, 7, 1, 8, 1, 6, 3, 9, 8, 9, 1, 8, 2,
                    9, 2, 7, 4, 1, 9, 6, 7, 5, 5, 4, 8, 8, 9, 3, 5, 7, 8, 6, 6, 5, 9, 9, 1, 4, 6,
                    8, 9, 7, 7, 6, 1, 1, 2, 5, 7, 9, 1, 8, 8, 7, 2, 2, 3, 6, 8, 1, 2, 9, 9, 8, 3,
                    3, 4, 7, 9,
                ]
            }
        );
    }
}
